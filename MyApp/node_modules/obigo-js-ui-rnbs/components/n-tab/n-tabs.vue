<template>
  <div class="obg-n-tabs-component">
    <div v-if="isBottomTab" class="obg-n-tabs-component-panels">
      <slot/>
    </div>
    <div class="wrapper"
         ref="tabList"
         :class="{'first-tab-select': firstTabSelected, 'obg-n-tabs-component-bottom-type': isBottomTab, 'obg-n-tabs-component-top-type': !isBottomTab}">
      <div
        role="tab-list"
        class="obg-n-tabs-component-tabs"
        :class="classTabLength"
      >
        <a
          v-for="(tab, i) in tabs"
          :aria-controls="tab.hash"
          :aria-selected="tab.isActive"
          @click="onClickTab(tab.hash, $event)"
          @jog-click="onJogClickTab(tab.hash, $event)"
          @mousedown="start"
          @mouseup="end"
          @touchstart="start"
          @mouseleave="end"
          @touchend="end"
          @touchcancel="end"
          @touchleave="end"
          v-obg-focus="{tabNumber: i, scene: focusScene}"
          class="obg-n-tabs-component-tab-a"
          :class="{'is-active': tab.isActive, 'is-disable': tab.isDisable, }"
          :style="{color:tab.isActive ? selectedColor : ''}"
          role="tab"
          :data-index="i"
        >
          <label
            class="obg-n-tabs-component-label"
          >
            {{tab.name}}
          </label>
        </a>
      </div>
    </div>
    <div v-if="!isBottomTab" class="obg-n-tabs-component-panels">
      <slot/>
    </div>
  </div>
</template>

<script>
  /**
   * @see Nissan only
   * @class n-tabs
   * @classdesc components/n-tabs
   * @param {boolean} [disabled=false] It present whether n-tabs is disabled.
   * @param {object} [options={useUrlFragment: true}]
   * @param {number} [default=0]
   * @param {string} [selectedColor='white'] It present selected tab text color
   * @param {string} [tabType='top'] It present tab position whether top or bottom.
   * @param {slot} [slot] n-tab elements
   *
   * @example
   * <obg-n-tabs
   * :selectedColor="'orange'"
   * >
   *   <obg-n-tab
   *    :name="'label'"
   *    >
   *    label contents
   *    </obg-n-tab>
   *   <obg-n-tab
   *    :name="'content'"
   *    >
   *    content.contents
   *    </obg-n-tab>
   *   <obg-n-tab
   *    :name="'play'"
   *    :isDisable="true"
   *    >
   *    play.contents
   *    </obg-n-tab>
   * </obg-n-tabs>
   */
  import Events from '../../features/events'
  export default {
    name: 'obg-n-tabs',
    props: {
      options: {
        type: Object,
        required: false,
        default: () => ({
          useUrlFragment: true
        })
      },
      default: {
        type: Number,
        default: 0
      },
      selectedColor: {
        type: String,
        default: 'white'
      },
      tabType: {
        type: String,
        default: 'top'
      },
      focusScene: {
        type: Number,
        default: 0
      }
    },
    data: () => ({
      tabs: [],
      activeTabHash: ''
    }),
    computed: {
      firstTabSelected () {
        return (this.tabs.length > 0) ? this.tabs[0].isActive : false
      },
      defaultIndex () {
        return this.tabs.length && this.tabs[this.default] ? this.default : 0
      },
      classTabLength () {
        return 'n-tabs-component-children-' + this.tabs.length
      },
      isBottomTab () {
        return this.tabType === 'bottom'
      }
    },
    created () {
      this.tabs = this.$children
    },
    mounted () {
      if (this.tabs.length < 2 || this.tabs.length > 4) {
        throw new Error('Count of n-tab length is ' + this.tabs.length + '\n Number of tab should be 2~4')
      }
      // window.addEventListener('hashchange', () => this.selectTab(window.location.hash))
      if (this.findTab(window.location.hash)) {
        this.selectTab(window.location.hash)
        return
      }
      if (this.tabs.length) {
        this.selectTab(this.tabs[this.defaultIndex].hash)
      }
      Events.$emit('tab:update', {
        tabNumber: 0,
        isFocus: false
      })
    },
    watch: {
      tabs (val, oldVal) {
        this.refreshTab()
      },
      default (val, oldVal) {
        if (val !== oldVal) this.refreshTab()
      }
    },
    activated () {
      if (this.findTab(window.location.hash)) {
        this.selectTab(window.location.hash)
        return
      }

      if (this.tabs.length) {
        this.selectTab(this.tabs[this.defaultIndex].hash)
      }
    },
    methods: {
      start (evt) {
        evt.currentTarget.classList.add('active')
      },
      end (evt) {
        evt.currentTarget.classList.remove('active')
      },
      findTab (hash) {
        return this.tabs.find(tab => {
          return tab.hash === hash
        })
      },
      refreshTab () {
        if (this.tabs.length) {
          this.selectTab(this.tabs[this.defaultIndex].hash)
        }
      },
      selectTab (selectedTabHash, event) {
        // See if we should store the hash in the url fragment.
        if (event && !this.options.useUrlFragment) {
          event.preventDefault()
        }

        const selectedTab = this.findTab(selectedTabHash)

        if (!selectedTab) {
          return
        }

        if (selectedTab.isDisable) {
          return
        }

        this.tabs.forEach(tab => {
          tab.isActive = (tab.hash === selectedTab.hash)
        })

        this.$emit('changed', {tab: selectedTab})

        this.activeTabHash = selectedTab.hash
      },

      setTabVisible (hash, visible) {
        const tab = this.findTab(hash)

        if (!tab) {
          return
        }

        tab.isVisible = visible

        if (tab.isActive) {
          // If tab is active, set a different one as active.
          tab.isActive = visible

          this.tabs.every((tab, index, array) => {
            if (tab.isVisible) {
              tab.isActive = true

              return false
            }

            return true
          })
        }
      },
      onClickTab (selectedTabHash, event) {
        const $tab = this.findTab(selectedTabHash)
        this.selectTab(selectedTabHash, event)
        $tab.$emit('click', event)
        const tabIndex = Number(event.currentTarget.dataset.index)
        Events.$emit('tab:update', {
          tabNumber: tabIndex,
          isFocus: false
        })
      },
      onJogClickTab (selectedTabHash, event) {
        this.selectTab(selectedTabHash, event)
        const tabIndex = Number(event.currentTarget.dataset.index)
        Events.$emit('tab:update', {
          tabNumber: tabIndex,
          lastOrder: event.detail.order,
          newOrder: event.detail.newOrder,
          isFocus: true
        })
      }
    }
  }
</script>

<style lang="scss" scoped>

  $bgColor: #000;
  $lineColor: white;
  $txtColor: white;
  $thickLine: solid 3px $lineColor;
  $tabsSidePadding: 40px;
  .obg-n-tabs-component {
    background-color: $bgColor;
    width: 1063px;
    padding: 0 39px;
    position: relative;
    float: left;
    left: 89px;
    &-bottom-type {
      position: relative;
      display: inline-block;
      width: 100%;
      .obg-n-tabs-component {
        &-tabs {
          padding: 0 $tabsSidePadding 20px $tabsSidePadding;
          flex: 1;
          display: flex;
          flex-direction: row;
          justify-content: center;
          border-top: solid 0 $lineColor;
          background-color: $bgColor;
          :first-child a{
            border-left: solid 1px $lineColor;
          }
          border: {
            top: 3px solid $lineColor;
          }
        }
        &-tab-a{
          min-height: 69px;
          height: 69px;
          position: relative;
          box-sizing: border-box;
          background-color: $bgColor;
          flex: 1;
          display: flex;
          flex-direction: column;
          color: $txtColor;
          font-size: 40px;
          user-select: none;
          text-decoration: none;
          margin: -3px 0 0 -20px;
          border: {
            left: 1px solid $lineColor;
            right:1px solid $lineColor;
            bottom: 1px solid $lineColor;
            top: 3px solid $lineColor;
            bottom-left-radius: 10px;
            bottom-right-radius: 15px;
          }
        }
      }
      .is-active {
        height: 73px;
        margin-bottom: -4px;
        z-index: 5 !important;
        border: {
          left: 3px solid $lineColor !important;
          right:3px solid $lineColor !important;
          bottom: 3px solid $lineColor !important;
          top: 0 solid $lineColor !important;
          bottom-left-radius: 10px;
          bottom-right-radius: 15px;
        }
      }
    }

    &-top-type {
      .obg-n-tabs-component {
        &-tabs {
          padding: 20px $tabsSidePadding 0 $tabsSidePadding;
          flex: 1;
          display: flex;
          flex-direction: row;
          justify-content: center;
          border-bottom: solid 0 $lineColor;
          background-color: $bgColor;
          :first-child a{
            border-left: solid 1px $lineColor;
          }
          border: {
            bottom: 3px solid $lineColor;
          }
        }
        &-tab-a {
          min-height: 69px;
          height: 69px;
          position: relative;
          box-sizing: border-box;
          background-color: $bgColor;
          flex: 1;
          display: flex;
          flex-direction: column;
          color: $txtColor;
          font-size: 40px;
          user-select: none;
          text-decoration: none;
          margin: 0 0 -3px -20px;
          border: {
            left: 1px solid $lineColor;
            right:1px solid $lineColor;
            top: 1px solid $lineColor;
            bottom: 3px solid $lineColor;
            top-left-radius: 10px;
            top-right-radius: 15px;
          }
        }
      }
      .is-active {
        height: 73px;
        margin-top: -4px;
        z-index: 5 !important;
        border: {
          left: 3px solid $lineColor !important;
          right:3px solid $lineColor !important;
          top: 3px solid $lineColor !important;
          bottom: 0 solid $lineColor !important;
          top-left-radius: 10px;
          top-right-radius: 15px;
        }
      }
    }

    &-label {
      display: block;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin: auto 20px auto 20px;
      font-size: 36pt;
      line-height: 1.5em;
    }

    &-panels {
      background-color: $bgColor;
      color: $txtColor;
    }

    .is-disable {
      color: rgba(230, 240, 255, 0.3);
      pointer-events: none;
    }

    &-children-2 &-tab-a {width: 45%;}
    &-children-3 &-tab-a {width: 30%;}
    &-children-4 &-tab-a {width: 23%;}
  }
  .obg-n-tabs-component-tab-a{
    &:first-child{
      z-index: 4;
    }
    &:nth-child(2){
      z-index: 3;
    }
    &:nth-child(3){
      z-index: 2;
    }
    &:nth-child(4){
      z-index: 1;
    }
  }
  .obg-n-tabs-component-top-type{
    .obg-n-tabs-component-tab-a{
      &.active{
        background-image: radial-gradient(center top, ellipse cover, #fafafa, #4b4d4e, #000000) !important;
        background-image: -webkit-radial-gradient(center top,  ellipse cover, #fafafa, #4b4d4e, #000000) !important;;
      }
      &.obg-focus{
        background-image: radial-gradient(center top, ellipse cover, #de4a01, #040404);
        background-image: -webkit-radial-gradient(center top,  ellipse cover, #de4a01, #040404);
      }
    }
  }
  .obg-n-tabs-component-bottom-type{
    .obg-n-tabs-component-tab-a{
      &.active{
        background-image: radial-gradient(center bottom, ellipse cover, #fafafa, #4b4d4e, #000000);
        background-image: -webkit-radial-gradient(center bottom,  ellipse cover, #fafafa, #4b4d4e, #000000);
      }
      &.obg-focus{
        background-image: radial-gradient(center bottom, ellipse cover, #de4a01, #040404);
        background-image: -webkit-radial-gradient(center bottom,  ellipse cover, #de4a01, #040404);
      }
    }
  }
</style>
