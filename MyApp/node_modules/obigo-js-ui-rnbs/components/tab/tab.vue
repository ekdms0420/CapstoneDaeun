<template>
  <div
    class="obg-tab"
    :class="[{
      'is-animated': animated,
    }, countClass]"
  >
    <!--div class="divider" /-->


    <div
      class="slide-factor"
      ref="slideFactor"
      v-if="animated"
      @mousedown="start"
      @mouseup="end"
      @mouseleave="end"
      @touchstart="start"
      @touchend="end"
      @touchcancel="end"
      @touchleave="end"
    ></div>
    <slot></slot>
    <!--div class="divider" /-->
  </div>
</template>

<script>
  /**
   * @see Renault, Nissan
   * @class tab
   * @classdesc components/tab
   * @param {slot} [slot] tab-item
   * @param {boolean} [animated=true]
   *
   * @example
   * <obg-tab v-model="btnGroup" :animated=true>
   *    <obg-tab-item :icon='player' :selected=false :disabled=false> Player </obg-tab-item>
   * </obg-tab>
   */
  import { parentMixin } from '../../mixins/multi-items'

  export default {
    name: 'obg-tab',
    mixins: [parentMixin],
    data () {
      return {
        tweeningWidth: 0,
        slidePosition: 0,
        clientWidth: 0,
        itemCount: 0
      }
    },
    props: {
      animated: {
        type: Boolean,
        default: true
      }
    },
    computed: {
      countClass () {
        return 'tab-' + this.itemCount
      }
    },
    watch: {
      currentIndex (val, oldVal) {
        if (this.animated) {
          const slidePosition = this.currentIndex * this.tweeningWidth
          if (typeof oldVal === 'undefined' || oldVal < 0) {
            this.tween(0, slidePosition, this.$slideFactor, 0)
          } else {
            const startValue = oldVal * this.tweeningWidth
            this.tween(startValue, slidePosition, this.$slideFactor, 200)
          }
        }
      }
    },
    mounted () {
      if (this.$children.length < 2 || this.$children.length > 4) {
        throw new Error('Count of tab-item is ' + this.$children.length + '\n Number of tab-item should be 2~4')
      }
      this.clientWidth = this.$el.clientWidth
      this.$slideFactor = this.$refs.slideFactor
      this.tweeningWidth = this.$children[1].$el.getBoundingClientRect().width
      if (this.$slideFactor) {
        this.$slideFactor.style.width = this.tweeningWidth + 'px'
      }
      this.$nextTick(() => {
        this.itemCount = this.$children.length
      })
    },
    updated () {
      this.$nextTick(() => {
        if (this.$children.length > 1 && this.animated) {
          this.tweeningWidth = this.$children[1].$el.getBoundingClientRect().width
          if (this.$slideFactor) {
            this.$slideFactor.style.width = this.tweeningWidth + 'px'
            this.$slideFactor.style.transform = 'translateX(' + (this.currentIndex * this.tweeningWidth) + 'px) translateZ(0px)'
            this.$slideFactor.style.transitionDuration = 0 + 'ms'
            this.$slideFactor.style.webkitTransitionDuration = 0 + 'ms'
            this.$slideFactor.classList.remove('first', 'last', 'center')
            this.$slideFactor.classList.add(this.currentIndex === 0 ? 'first' : (this.currentIndex + 1 === this.itemCount) ? 'last' : 'center')
          }
        }
      })
    },
    methods: {
      tween: function (startValue, endValue, el, duration) {
        const _style = el.style
        _style.transitionDuration = duration + 'ms'
        _style.webkitTransitionDuration = duration + 'ms'
        _style.transform = 'translateX(' + (endValue) + 'px) translateZ(0px)'
        _style.WebkitTransform = 'translateX(' + (endValue) + 'px) translateZ(0px)'
      },
      start (evt) {
        this.$slideFactor.classList.add('active')
      },
      end (evt) {
        this.$slideFactor.classList.remove('active')
      }
    }
  }
</script>

<style lang="scss" scoped>
/*
  @import '../../styles/common/colors.variables';
  */

</style>
