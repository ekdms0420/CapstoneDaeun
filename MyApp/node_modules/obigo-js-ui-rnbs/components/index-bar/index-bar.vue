<template>
  <div
    class="obg-index-bar-component"
    :class="{'is-disabled': isDisable, 'expand': expandedMode}"
    data-type="focus-control-able"
  >
    <obg-button
      v-if="hasIcon"
      class="obg-index-bar-icon"
      type="round"
      :icon="icon"
      @click.stop="clickIcon"
    >
    </obg-button>
    <div class="wrapper">
      <obg-button v-if="expandedMode"
                  :disabled="isDisable || !hasPrev"
                  icon="sc-up"
                  @click.stop="clickPrev"
                  class="top-arrow">
      </obg-button>
      <div class="obg-index-bar-outline"
           :class="{'obg-index-bar-has-outline':hasOutline, [indexSize]: true}"
      >
        <div
          v-for="(item, i) of computedIndexes"
          v-if="isRangeInPage(i)"
        >
          <div class="obg-index-bar-index"
               :class="{'is-disabled': item.disabled}"
               @click.stop="clickIndex(item, i)">{{item.text}}
          </div>
          <div class="obg-index-bar-splitter"
               @click.stop="clickSplitter(item, i)"
               v-if="hasSplitterIndex(i)">
            <div :class="splitter"></div>
          </div>
        </div>
      </div>
      <obg-button v-if="expandedMode"
                  :disabled="isDisable || !hasNext"
                  icon="sc-down"
                  @click.stop="clickNext"
                  class="bottom-arrow">
      </obg-button>
    </div>
  </div>
</template>

<script>
  import button from '../button'
  import focusControlMixin from '../../mixins/focus-control'
  /**
   * @see Nissan only
   * @class index-bar
   * @classdesc components/index-bar
   * @param {array} [indexes={text: '', index: -1, disabled: false}] Indexes of index bor
   * @param {string} [splitters=['line', 'dot']] type: dot/line/none
   * @param {string} [indexSizes=['large', 'normal']] size: small/normal/large
   * @param {boolean} [isDisable=false] It present whether index bar is disabled.
   * @param {boolean} [isExpanded=false] If is expanded index bar, is true.
   * @param {Array} [pageSize=[5, 11]] It's size of pages [Expended, Normal]
   * @param {number} [firstOfPage=0] Index value of indexes be first item of page.
   * @param {string} [icon] If need to icon button, it has icon name in icon button
   * @event [clickIndex] when occur on click index item, param: clicked index item {item}.
   * @event [clickSplitter] when occur on click splitter, param: previous index item of splitter {item}.
   * @event [clickIcon] when occur on click icon button.
   * @example
   *  <obg-index-bar
   *  :icon="'menu'"
   *  :splitters="'line'"
   *  :isExpanded="true"
   *  :indexes="computedExpandedIndexes"
   *  :pageSize="pageLength"
   *  :firstOfPage="firstOfPage"
   *  v-model="firstOfPage"
   *  @clickIcon="onClickIcon"
   *  @clickIndex="onClickIndex"/>
   */
  const INDEX_MIN_LEN = 2
  export default {
    name: 'index-bar',
    components: {
      'obg-button': button
    },
    mixins: [focusControlMixin],
    props: {
      icon: {
        type: String
      },
      value: {
        type: Boolean,
        default: false
      },
      splitters: {
        // dot, line, none
        type: Array,
        default: () => {
          return ['line', 'dot'] // [expended, normal]
        }
      },
      isDisable: {
        type: Boolean,
        default: false
      },
      isExpanded: {
        type: Boolean,
        default: false
      },
      firstOfPage: {
        type: Number,
        default: 0
      },
      pageSizes: {
        type: Array,
        default: () => {
          return [5, 11] // [expended, normal]
        }
      },
      indexes: {
        type: Array,
        default: () => {
          return [
            {text: '', index: -1, disabled: false},
            {text: '', index: -1, disabled: false}
          ]
        },
        validator (value) {
          return value.length === 2 && value[0].length >= INDEX_MIN_LEN && value[1].length >= INDEX_MIN_LEN
        }
      },
      indexSizes: {
        type: Array,
        default: () => {
          return ['large', 'normal']
        }
        // validator (value) {
        //   return ['small', 'normal', 'large'].indexOf(value) > -1
        // }
      }
    },
    computed: {
      hasIcon () {
        return this.icon !== undefined
      },
      hasPrev () {
        return this.firstIndexOfPage > 0
      },
      hasNext () {
        let next = this.firstIndexOfPage + this.pageSize - 1
        return next < this.computedIndexes.length - 1
      },
      expandedMode: {
        get () {
          return this.value
        },
        set (value) {
          this.$emit('input', value)
        }
      },
      pageSize () {
        return this.expandedMode ? this.pageSizes[0] : this.pageSizes[1]
      },
      splitter () {
        return this.expandedMode ? this.splitters[0] : this.splitters[1]
      },
      indexSize () {
        return this.expandedMode ? this.indexSizes[0] : this.indexSizes[1] // ['large', 'normal']
      },
      hasOutline () {
        return !this.expandedMode
      },
      computedIndexes () {
        return this.expandedMode ? this.indexes[0] : this.indexes[1]
      },
      lastIndexOfPage () {
        let next = this.firstIndexOfPage + this.pageSize - 1
        if (next > this.computedIndexes.length - 1) {
          next = this.computedIndexes.length - 1
        }
        return next
      }
    },
    data: () => {
      return {
        firstIndexOfPage: 0,
        indexElms: []
      }
    },
    watch: {
      firstOfPage (val) {
        let nextFirstIndexOfPage = val
        if (!Number.isInteger(val)) {
          return
        }
        if (val < 0) {
          nextFirstIndexOfPage = 0
        }
        if (val > this.computedIndexes.length - 1) {
          nextFirstIndexOfPage = this.computedIndexes.length - 1
        }
        this.firstIndexOfPage = nextFirstIndexOfPage
      }
    },
    mounted () {
      if (this.firstOfPage) {
        this.firstIndexOfPage = this.firstOfPage
      }
      this.expandedMode = this.isExpanded
      this.$on('focus:control-loss', () => {
        this.toggleExpandedMode(false)
      })
    },
    methods: {
      toggleExpandedMode (flag, index = 0) {
        // console.log('toggleExpandedMode : ' + flag + ' / ' + index)
        if (flag && index !== 0) {
          // calculate first index
          let pageHalfSize = parseInt(this.pageSizes[0] / 2)
          let minIdx = 0
          let maxIdx = this.indexes[0].length - 1
          let idx = index - pageHalfSize
          this.firstIndexOfPage = idx < minIdx ? minIdx : idx > maxIdx ? maxIdx : idx
        } else {
          this.firstIndexOfPage = 0
        }
        this.expandedMode = flag
      },
      clickIndex (item, index) {
        if (this.isDisable) return
        if (item.disabled) {
          return
        }
        let idx = this.indexes[0].findIndex(val => {
          return val.text === item.text
        })
        this.toggleExpandedMode(!this.expandedMode, idx)
        this.$emit('clickIndex', {item})
      },
      clickSplitter (item, index) {
        if (this.isDisable) return
        if (this.expandedMode) {
          return
        }
        let pageHalfSize = parseInt(this.pageSizes[0] / 2)
        let idx = this.indexes[0].findIndex(val => {
          return val.text === item.text
        })
        if (idx + pageHalfSize < this.indexes[0].length) {
          idx += pageHalfSize
        }
        let displayItem = this.indexes[0][idx]
        this.toggleExpandedMode(!this.expandedMode, idx)
        this.$emit('clickSplitter', {item: displayItem})
      },
      clickPrev () {
        if (this.isDisable) return
        if (this.firstIndexOfPage - 1 < 0) {
          return
        }
        let nextFirstIndexOfPage = this.firstIndexOfPage - this.pageSize
        if (nextFirstIndexOfPage < 0) {
          nextFirstIndexOfPage = 0
        }
        this.firstIndexOfPage = nextFirstIndexOfPage
      },
      clickNext () {
        if (this.isDisable) return
        let lastIndexOfIndexes = this.computedIndexes.length - 1
        if (this.lastIndexOfPage >= lastIndexOfIndexes) {
          return
        }
        let nextFirstIndexOfPage = this.firstIndexOfPage + this.pageSize
        if (nextFirstIndexOfPage > lastIndexOfIndexes) {
          nextFirstIndexOfPage = lastIndexOfIndexes
        }
        this.firstIndexOfPage = nextFirstIndexOfPage
      },
      clickIcon () {
        if (this.isDisable) return
        this.$emit('clickIcon')
      },
      isRangeInPage (i) {
        return i >= this.firstIndexOfPage && i <= this.lastIndexOfPage
      },
      hasSplitterIndex (i) {
        if (this.splitter === 'none') {
          return false
        }
        return i + 1 <= this.lastIndexOfPage
      },
      removeFocus () {
        if (this.$el.querySelector('.obg-focus')) {
          this.$el.querySelector('.obg-focus').classList.remove('obg-focus')
        }
      },
      onControlIn () {
        // console.log('control in')
        if (!this.expandedMode) {
          this.toggleExpandedMode(true)
        }
        this.$el.addEventListener('mousedown', this.exitFocusMode)
        this.$el.addEventListener('touchstart', this.exitFocusMode)
        this.$nextTick(() => {
          this.removeFocus()
          this.indexElms = Array.from(this.$el.querySelectorAll('.obg-index-bar-index'))
          this.setFocusOnToIndex(2, false)
        })
      },
      onRotate ({mode}) {
        // console.log('on rotate')
        this.removeFocus()
        if (mode === this.hardkeyCodes.mode.HARDKEY_MODE_RIGHT) {
          this.setFocusOnToIndex(this.currentFocusIndex + 1, false)
        } else {
          this.setFocusOnToIndex(this.currentFocusIndex - 1, true)
        }
      },
      findFocusableIndex (index = 2, isUp = false) {
        let indexes
        if (isUp) {
          indexes = this.indexElms.slice(0, index + 1).reverse()
        } else {
          indexes = this.indexElms.slice(index)
        }
        for (var i = 0; i < indexes.length; i++) {
          if (!indexes[i].classList.contains('is-disabled')) {
            return {
              el: indexes[i],
              index: (isUp) ? index - i : index + i
            }
          }
        }
      },
      setFocusOnToIndex (index = 2, isUp = false) {
        const focusableObj = this.findFocusableIndex(index, isUp)
        if (focusableObj) {
          this.currentFocusIndex = focusableObj.index
          this.currentFocusElement = focusableObj.el
          this.currentFocusElement.classList.add('obg-focus')
        } else {
          if (isUp && this.hasPrev) {
            this.clickPrev()
            this.$nextTick(() => {
              this.indexElms = Array.from(this.$el.querySelectorAll('.obg-index-bar-index'))
              this.setFocusOnToIndex(4, true)
            })
          } else if (!isUp && this.hasNext) {
            this.clickNext()
            this.$nextTick(() => {
              this.indexElms = Array.from(this.$el.querySelectorAll('.obg-index-bar-index'))
              this.setFocusOnToIndex(0, false)
            })
          } else {
            this.currentFocusElement.classList.add('obg-focus')
          }
        }
      },
      onRotateClick () {
        const clickEvent = new MouseEvent('click', {
          'view': window,
          'bubbles': true,
          'cancelable': false,
          'currentTarget': this.currentFocusElement,
          'isFocus': true,
          'isTrusted': false
        })
        this.currentFocusElement.dispatchEvent(clickEvent)
        this.toggleExpandedMode(false)
        this.$el.removeEventListener('mousedown', this.exitFocusMode)
        this.$el.removeEventListener('touchstart', this.exitFocusMode)
      },
      exitFocusMode () {
        this.toggleExpandedMode(false)
        this.$el.removeEventListener('mousedown', this.exitFocusMode)
        this.$el.removeEventListener('touchstart', this.exitFocusMode)
        this.exitFocusControlMode()
        this.$focus.exitFocusMode()
      }
    }
  }
</script>

<style lang="scss" scoped>
  .obg-index-bar {
    &-component {
      position: fixed;
      top: 42px;
      left: 20px;
      float: left;
      width: 96px;
      height: 100%;
      .wrapper {
        text-align: center;
        font-size: 37px;
        width: 96px;
        height: auto;
        .top-arrow {
          margin-bottom: 0;
        }
        .bottom-arrow {
          margin-top: -20px;
        }
        i{
          display: block;
          height: 94px !important;
        }
      }
    }

    &-icon {
      margin: 35px auto 17px auto;
      width: 69px;
      height: 69px;
      border: 2px solid #646464;
      border-radius: 50%;
      font-size: 20px;
      &.active{
        background: radial-gradient(#adadad 20%, #ffffff 70%);
        & > i{
          color: #010101;
        }
      }
      & > i {
        margin: 2px 0 0 2px;
      }
    }
    &-index {
      text-transform: uppercase;
    }

    &-splitter {
      .dot {
        width: 3px;
        border-radius: 50%;
        margin: 0 auto;
        border: 3px solid;
      }
      .line {
        width: 65px;
        height: 2px;
        margin-left: 4px;
        background-color: #6d6d7c;
      }
    }

    &-outline {
      padding: 23px 0 23px 0;
      display: inline-table;
      justify-content: center;
      &.small {
        width: 32px;
        font-size: 30px;
        .obg-index-bar-splitter {
          padding: 17px 0;
        }
      }
      &.normal {
        width: 32px;
        font-size: 37px;
        .obg-index-bar-splitter {
          padding: 17px 0;
        }
      }
      &.large {
        font-size: 50px;
        .obg-index-bar-splitter {
          padding: 11px 0;
        }
      }
    }
    &-has-outline {
      margin: 0 20px 0;
      background-color: rgba(255, 255, 255, .25);
      border-radius: 15px;
      &.large{
        margin: 10px 17px 0;
      }
    }
    &-has-outline &-index {
      padding: 0;
    }

    &-component.is-disabled {
      color: rgba(255, 255, 255, .25);
    }
    &-index.is-disabled {
      color: rgba(255, 255, 255, .25);
    }
    &-component.is-disabled &-splitter .dot {
      border: 2px solid rgba(255, 255, 255, .25);
    }
    &-component.expand{
      .obg-index-bar-icon{
        display: none;
      }
      .wrapper .obg-index-bar-outline{
        padding: 0;
        .obg-index-bar-index{
          &:active, &.active{
            text-shadow: 0px 0px 10px #000000, 0px 0px 30px #000000;
            background: radial-gradient(ellipse at center, #ffffff 0%,rgba(255, 255, 255, 0) 60%);
          }
          &.obg-focus{
            text-shadow: 0px 0px 10px #df4c04, 0px 0px 30px #df4c04;
            background: radial-gradient(ellipse at center, #dc7501 0%, rgba(0, 0, 0, 0) 60%);
          }
          //&.obg-focus {
            //text-shadow: 0px 0px 3px #df4c04, 0 0 1px #df4c04, 0 0 3px #df4c04, 0 0 1px #df4c04;
            //color: #df4c04;
            //&:before{
              //width: 100px;
              //height: 100px;
              //position: absolute;
              //content: '';
              //display: block;
              //background: radial-gradient(ellipse at center, #df4c04 0%, rgba(255, 255, 255, 0) 50%);
              //margin-left: -13px;
              //margin-top: -22px;
              //opacity: 0.7;
            //}
          //}
        }
        &.large {
          position: relative;
          width: 72px;
          line-height: 125%;
          .obg-index-bar-index{
            display: inline-block;
            margin: 3px auto;
            width: 62px;
            &.obg-focus {
              &:before{
                margin-top: -15px;
              }
            }
          }
        }
        &.normal {
          .obg-index-bar-index{
            display: inline-block;
            margin: 1px auto;
            width: 57px;
            padding: 10px 0;
          }
        }
        &.small {
          .obg-index-bar-index{
            display: inline-block;
            margin: 3px auto;
            width: 40px;
            &.obg-focus{
              &:before{
                width:90px;
                height:90px;
                margin-left: -11px;
                margin-top: -24px;
              }
            }
          }
        }
      }
    }
  }
</style>
