<template>
  <div class='obg-v-cover-flow-slide' @click="handleClick" @touchstart='down' @mousedown='down' @touchend='up' @mouseup='up' @mouseleave='up' @mousecancel='up' @touchcancel='up' @mousemove='move' @touchmove='move' :index="index">
    <slot></slot>
  </div>
</template>

<script>
  /**
   * @see Renault, Nissan
   * @class v-cover-flow-slide
   * @classdesc components/v-cover-flow-slide
   * @param {boolean} [clickPropagation=true]
   * @param {boolean} [fixed=false]
   * @param {number} [index=true]
   * @example
   * <obg-v-cover-flow-slide>Slide1</obg-v-cover-flow-slide>
   *
   */
  const vertiThreshold = 40
  const horiThreshold = 140
  export default {
    name: 'obg-v-cover-flow-slide',
    vertiThreshold: vertiThreshold,   // static variable to make scroll
    horiThreshold: horiThreshold,   // static variable to make scroll
    props: {
      fixed: {
        type: Boolean,
        default: false
      },
      clickPropagation: {
        type: Boolean,
        default: true
      },
      index: {
        type: Number,
        require: true
      }
    },
    methods: {
      handleClick (e) {
        if (this.isOut) {       // 추후 slide left를 이용한 삭제 기능 구현시 deltaX 값이 달라질 수 있기 때문에 click핸들러에서 한번 더 체크해서 click을 결정.
          return
        }
        this.clickDownPoint = undefined
        this.$emit('click', e)
        this.$parent.$emit('updateIndex', this.$el, this.index)
        var comps = this.$el.querySelectorAll('input, select, button')
        if (comps.length === 1 && this.clickPropagation === true) {
          for (var i = 0; i < comps.length; i++) {
            var ev = document.createEvent('MouseEvents')
            var target = comps[i]
            ev.initMouseEvent('click', false, true, e.view, 1, target.screenX, target.screenY, target.clientX, target.clientY, e.ctrlKey, e.altKey, e.shiftKey, e.metaKey, 0, null)
            ev._constructed = true
            target.dispatchEvent(ev)
          }
        }
      },
      down (e) {
        e = e.touches ? e.touches[0] : e
        this.isOut = false
        let el = e.target
        this.clickDownPoint = {
          x: e.clientX,
          y: e.clientY
        }
        do {
          if (el === this.$el) {
            break
          }
          if (el.tagName === 'BUTTON' || el.tagName === 'INPUT' || el.tagName === 'SELECT') {
            return
          }
          el = el.parentElement
        } while (el.parentElement)
        this.$el.classList.add('active')
      },
      up (e) {
        e = e.changedTouches ? e.changedTouches[0] : e
        this.$el.classList.remove('active')
      },
      move (e) {
        e = e.changedTouches ? e.changedTouches[0] : e
        if (this.clickDownPoint) {
          var deltaX = Math.abs(e.clientX - this.clickDownPoint.x)
          var deltaY = Math.abs(e.clientY - this.clickDownPoint.y)

          if (deltaX > horiThreshold || deltaY > vertiThreshold) {
            this.$el.classList.remove('active')
            this.isOut = true
          }
        }
      }
    },
    mounted () {
      this.$on('jog-click', () => {
        const focusControlComponent = this.$el.querySelector('[data-type="focus-control-able"]')
        if (focusControlComponent) {
          const jogClickEvent = new CustomEvent('jog-click', {
            'detail': {}
          })
          focusControlComponent.dispatchEvent(jogClickEvent)
        }
      })
    }
  }
</script>
<style lang="scss" >
</style>

